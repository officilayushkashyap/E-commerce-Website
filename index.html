<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShopHub ‚Äî Demo Store</title>
  <style>
    /* ===== Reset & Base ===== */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#1f2937;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    /* ===== Layout ===== */
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .auth-screen, .app {min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}

    /* ===== Auth box ===== */
    .card{
      background:#fff;border-radius:16px;padding:32px;box-shadow:0 18px 50px rgba(2,6,23,0.2);width:100%;max-width:480px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{font-size:32px}
    h1.title{font-size:22px;margin-top:8px;color:#0f172a}
    p.lead{color:#475569;margin-top:6px}

    .form-row{margin-top:18px}
    label{display:block;color:#0f172a;font-weight:600;margin-bottom:8px;font-size:14px}
    input[type="text"], input[type="email"], input[type="password"], textarea, select{
      width:100%;padding:12px;border-radius:10px;border:1px solid #e6e9ee;font-size:15px;background:#fff
    }
    textarea{min-height:90px;resize:vertical}
    .muted{color:#64748b;font-size:13px;margin-top:6px}

    .btn{display:inline-block;padding:12px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:700}
    .btn-primary{background:#667eea;color:#fff;box-shadow:0 8px 30px rgba(102,126,234,0.18)}
    .btn-ghost{background:transparent;border:1px solid #e6e9ee;color:#0f172a}

    .auth-switch{margin-top:14px;text-align:center;color:#64748b}
    .auth-switch a{color:#4f46e5;font-weight:700;cursor:pointer}

    /* ===== App header ===== */
    .header{
      background:#fff;padding:14px 20px;border-radius:12px;margin:12px 0;box-shadow:0 6px 24px rgba(2,6,23,0.08);
      position:sticky;top:14px;z-index:40
    }
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;max-width:1200px;margin:0 auto}
    .nav{display:flex;gap:10px;align-items:center}
    .nav button{background:transparent;border:0;padding:8px 12px;border-radius:10px;color:#475569;cursor:pointer}
    .nav button.active{background:#eef2ff;color:#312e81}
    .user-info{display:flex;align-items:center;gap:10px;color:#0f172a}
    .user-pill{background:#f8fafc;padding:8px 12px;border-radius:999px;border:1px solid #e6e9ee;font-weight:600}

    /* ===== Main content card ===== */
    .main-card{background:#fff;border-radius:16px;padding:26px;margin-top:18px;box-shadow:0 18px 50px rgba(2,6,23,0.06)}
    .search-row{display:flex;gap:12px;align-items:center;margin-bottom:18px}
    .search-row input{flex:1;padding:12px;border-radius:12px;border:1px solid #e6e9ee}

    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:18px}
    .chip{padding:8px 14px;border-radius:999px;border:1px solid #e6e9ee;background:#fff;color:#334155;cursor:pointer;font-weight:600}
    .chip.active{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}

    /* ===== Products grid ===== */
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}
    .product{
      border-radius:12px;overflow:hidden;border:1px solid #eef2ff;background:linear-gradient(180deg,#fff 0,#fbfdff 100%);
      display:flex;flex-direction:column;justify-content:space-between;padding:12px
    }
    .product .media{height:140px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:46px;background:linear-gradient(135deg,#eef2ff,#f3e8ff)}
    .product h3{font-size:16px;margin-top:10px;color:#0f172a}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .price{font-weight:800;color:#4338ca;font-size:18px}
    .stock{font-size:13px;color:#64748b}

    .product .actions{margin-top:12px;display:flex;gap:8px}
    .product .actions button{flex:1}

    /* ===== Cart/checkout ===== */
    .cart-layout{display:grid;grid-template-columns:1fr 320px;gap:18px}
    .cart-list{display:flex;flex-direction:column;gap:12px}
    .cart-item{display:flex;gap:12px;align-items:center;background:#f8fafc;padding:12px;border-radius:12px}
    .cart-item .emoji{font-size:30px;width:58px;height:58px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#fff}
    .cart-item .info{flex:1}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{width:34px;height:34px;border-radius:8px;border:0;background:#4f46e5;color:#fff;font-weight:700;cursor:pointer}
    .summary{background:#fff;padding:16px;border-radius:12px;border:1px solid #eef2ff}

    /* ===== Orders ===== */
    .order{background:#f8fafc;padding:14px;border-radius:12px;border:1px solid #eef2ff}

    /* ===== Notification ===== */
    .toast{position:fixed;right:20px;top:18px;padding:12px 16px;border-radius:10px;color:#fff;font-weight:700;z-index:200}
    .toast.ok{background:#10b981}
    .toast.err{background:#ef4444}

    /* ===== Responsive ===== */
    @media (max-width:900px){.cart-layout{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- AUTH SCREEN -->
  <div id="authScreen" class="auth-screen container">
    <div class="card">
      <div class="brand">
        <div class="logo">üõçÔ∏è</div>
        <div>
          <h1 class="title">ShopHub</h1>
          <p class="lead">Demo e-commerce ‚Äî try the demo account or register</p>
        </div>
      </div>

      <!-- LOGIN -->
      <div id="loginBox" style="margin-top:18px">
        <form id="loginForm">
          <div class="form-row">
            <label for="loginEmail">Email</label>
            <input id="loginEmail" type="email" required placeholder="demo@shop.com" value="demo@shop.com" />
          </div>
          <div class="form-row">
            <label for="loginPassword">Password</label>
            <input id="loginPassword" type="password" required placeholder="demo123" value="demo123" />
          </div>

          <div style="display:flex;gap:10px;margin-top:16px">
            <button type="submit" class="btn btn-primary">Login</button>
            <button type="button" id="gotoRegister" class="btn btn-ghost">Create account</button>
          </div>

          <p class="auth-switch muted" style="margin-top:14px">
            Demo: <strong>demo@shop.com</strong> / <strong>demo123</strong>
          </p>
        </form>
      </div>

      <!-- REGISTER (hidden) -->
      <div id="registerBox" style="display:none;margin-top:18px">
        <form id="registerForm">
          <div class="form-row">
            <label for="regName">Full name</label>
            <input id="regName" type="text" required placeholder="Jane Doe" />
          </div>
          <div class="form-row">
            <label for="regEmail">Email</label>
            <input id="regEmail" type="email" required placeholder="you@example.com" />
          </div>
          <div class="form-row">
            <label for="regPassword">Password</label>
            <input id="regPassword" type="password" required minlength="6" placeholder="6+ characters" />
          </div>

          <div style="display:flex;gap:10px;margin-top:16px">
            <button type="submit" class="btn btn-primary">Create account</button>
            <button type="button" id="gotoLogin" class="btn btn-ghost">Back to login</button>
          </div>
          <p class="muted" style="margin-top:12px">Your data is stored locally in your browser (localStorage).</p>
        </form>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" class="app container" style="display:none">
    <div style="width:100%">
      <div class="header">
        <div class="header-inner">
          <div style="display:flex;align-items:center;gap:14px">
            <div class="logo">üõçÔ∏è</div>
            <div>
              <div style="font-weight:800">ShopHub</div>
              <div style="font-size:12px;color:#64748b">Demo store (local only)</div>
            </div>
          </div>

          <div class="nav" id="navButtons">
            <button data-view="products" class="active">Products</button>
            <button data-view="cart">Cart (<span id="navCartCount">0</span>)</button>
            <button data-view="orders">Orders</button>
          </div>

          <div class="user-info">
            <div id="userName" class="user-pill">‚Äî</div>
            <button id="logoutBtn" class="btn btn-ghost">Logout</button>
          </div>
        </div>
      </div>

      <!-- Main card -->
      <div class="main-card">
        <!-- PRODUCTS VIEW -->
        <section id="view-products">
          <div class="search-row">
            <input id="searchInput" placeholder="Search products, e.g. headphones" />
            <select id="sortSelect" style="padding:10px;border-radius:10px;border:1px solid #e6e9ee">
              <option value="featured">Featured</option>
              <option value="price-asc">Price: low ‚Üí high</option>
              <option value="price-desc">Price: high ‚Üí low</option>
              <option value="rating">Top rated</option>
            </select>
          </div>

          <div class="filters" id="categoryFilters"></div>

          <div class="grid" id="productsGrid"></div>
        </section>

        <!-- CART VIEW -->
        <section id="view-cart" style="display:none">
          <div class="cart-layout">
            <div>
              <h2 style="margin-bottom:12px">Shopping Cart</h2>
              <div class="cart-list" id="cartList"></div>
            </div>

            <aside class="summary">
              <h3>Order summary</h3>
              <div style="display:flex;justify-content:space-between;margin-top:12px">
                <div class="muted">Subtotal</div>
                <div id="summarySubtotal">$0.00</div>
              </div>
              <div style="display:flex;justify-content:space-between;margin-top:8px">
                <div class="muted">Shipping</div>
                <div>Free</div>
              </div>
              <div style="border-top:1px dashed #eef2ff;margin-top:14px;padding-top:14px;display:flex;justify-content:space-between">
                <div style="font-weight:800">Total</div>
                <div id="summaryTotal" style="font-weight:800;color:#4338ca">$0.00</div>
              </div>

              <button id="checkoutBtn" class="btn btn-primary" style="margin-top:14px;width:100%">Proceed to checkout</button>
            </aside>
          </div>
        </section>

        <!-- CHECKOUT VIEW -->
        <section id="view-checkout" style="display:none">
          <h2 style="margin-bottom:12px">Checkout</h2>
          <form id="checkoutForm">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
              <div>
                <label>Card number</label>
                <input id="cardNumber" required placeholder="1234 5678 9012 3456" />
              </div>
              <div>
                <label>Cardholder name</label>
                <input id="cardName" required placeholder="Jane Doe" />
              </div>
              <div>
                <label>Expiry (MM/YY)</label>
                <input id="cardExpiry" required placeholder="MM/YY" />
              </div>
              <div>
                <label>CVV</label>
                <input id="cardCvv" required placeholder="123" maxlength="4" />
              </div>
            </div>

            <div style="margin-top:12px">
              <label>Shipping address</label>
              <textarea id="shipAddress" required placeholder="123 Main St, City, State, ZIP"></textarea>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px">
              <div class="muted">Total:</div>
              <div id="checkoutAmount" style="font-weight:900;color:#4338ca">$0.00</div>
            </div>

            <div style="margin-top:14px;display:flex;gap:10px">
              <button type="submit" class="btn btn-primary">Place order</button>
              <button type="button" id="cancelCheckout" class="btn btn-ghost">Cancel</button>
            </div>
          </form>
        </section>

        <!-- ORDERS VIEW -->
        <section id="view-orders" style="display:none">
          <h2 style="margin-bottom:12px">My orders</h2>
          <div id="ordersList"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" style="display:none" class="toast"></div>

  <script>
    /***************
     * Data & Setup
     ***************/
    const demoUsers = [
      { name: 'Demo User', email: 'demo@shop.com', password: 'demo123', createdAt: new Date().toISOString() },
      { name: 'John Doe', email: 'john@example.com', password: 'pass123', createdAt: new Date().toISOString() }
    ];

    const initialProducts = [
      { id:1,name:'Premium Wireless Headphones',price:299.99,category:'Electronics',emoji:'üéß',stock:15,rating:4.8,featured:true},
      { id:2,name:'Smart Watch Pro',price:399.99,category:'Electronics',emoji:'‚åö',stock:8,rating:4.6,featured:true},
      { id:3,name:'USB-C Hub 7-in-1',price:49.99,category:'Electronics',emoji:'üîå',stock:30,rating:4.5},
      { id:4,name:'Mechanical Gaming Keyboard',price:149.99,category:'Electronics',emoji:'‚å®Ô∏è',stock:12,rating:4.7},
      { id:5,name:'Premium Leather Jacket',price:199.99,category:'Fashion',emoji:'üß•',stock:10,rating:4.7,featured:true},
      { id:6,name:'Running Sneakers',price:119.99,category:'Fashion',emoji:'üëü',stock:28,rating:4.6},
      { id:7,name:'Yoga Mat Premium',price:49.99,category:'Sports',emoji:'üßò',stock:27,rating:4.8},
      { id:8,name:'Stainless Water Bottle',price:24.99,category:'Home',emoji:'üíß',stock:60,rating:4.7},
      { id:9,name:'Apple MacBook Air',price:240.99,category:'Electronics',emoji:'üíª',stock:60,rating:4.7}
    ];

    // app state (runtime)
    const State = {
      currentUser: null,
      products: [],
      cart: [],
      orders: [],
      selectedCategory: 'all',
      search: '',
      sortBy: 'featured'
    };

    // helpers: localStorage keys (per user)
    const LS_USER_KEY = 'shophub_currentUser';
    const LS_PRODUCTS_KEY = 'shophub_products';
    // per-user keys: cart_{email}, orders_{email}, user_{email}
    const userCartKey = email => `shophub_cart_${email}`;
    const userOrdersKey = email => `shophub_orders_${email}`;
    const userKey = email => `shophub_user_${email}`;

    /****************
     * Utility funcs
     ****************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function fmt(n){ return '$' + Number(n).toFixed(2); }
    function toast(msg, ok=true){
      const el = $('#toast');
      el.textContent = msg;
      el.className = 'toast ' + (ok ? 'ok' : 'err');
      el.style.display = 'block';
      clearTimeout(window.__toastTm);
      window.__toastTm = setTimeout(()=> el.style.display='none', 2800);
    }

    /*******************
     * Persistence Init
     *******************/
    function ensureSeeded(){
      // products
      if(!localStorage.getItem(LS_PRODUCTS_KEY)) {
        localStorage.setItem(LS_PRODUCTS_KEY, JSON.stringify(initialProducts));
      }
      // demo users
      demoUsers.forEach(u=>{
        const k = userKey(u.email);
        if(!localStorage.getItem(k)){
          localStorage.setItem(k, JSON.stringify(u));
        }
      });
    }

    function loadProducts(){
      try {
        State.products = JSON.parse(localStorage.getItem(LS_PRODUCTS_KEY)) || initialProducts;
      } catch(e){ State.products = initialProducts.slice(); }
    }

    /****************
     * Auth handlers
     ****************/
    function saveCurrentUserToLS(user){
      localStorage.setItem(LS_USER_KEY, JSON.stringify(user));
    }
    function clearCurrentUserFromLS(){ localStorage.removeItem(LS_USER_KEY); }

    function loadSession(){
      const s = localStorage.getItem(LS_USER_KEY);
      if(!s) return false;
      try{
        const user = JSON.parse(s);
        State.currentUser = user;
        // load user's cart and orders
        State.cart = JSON.parse(localStorage.getItem(userCartKey(user.email)) || '[]');
        State.orders = JSON.parse(localStorage.getItem(userOrdersKey(user.email)) || '[]');
        return true;
      }catch(e){ return false; }
    }

    async function registerUser(name,email,password){
      if(!name||!email||!password){ toast('Please fill fields',false); return false; }
      const k = userKey(email);
      if(localStorage.getItem(k)){ toast('Account already exists',false); return false; }
      const newUser = { name, email, password, createdAt: new Date().toISOString() };
      localStorage.setItem(k, JSON.stringify(newUser));
      // initialize empty cart/orders
      localStorage.setItem(userCartKey(email),'[]');
      localStorage.setItem(userOrdersKey(email),'[]');
      State.currentUser = newUser;
      saveCurrentUserToLS(newUser);
      State.cart = [];
      State.orders = [];
      toast('Account created ‚Äî logged in');
      return true;
    }

    function loginUser(email,password){
      const k = userKey(email);
      const raw = localStorage.getItem(k);
      if(!raw){ toast('User not found',false); return false; }
      const user = JSON.parse(raw);
      if(user.password !== password){ toast('Invalid credentials',false); return false; }
      State.currentUser = user;
      // load cart/orders
      State.cart = JSON.parse(localStorage.getItem(userCartKey(email)) || '[]');
      State.orders = JSON.parse(localStorage.getItem(userOrdersKey(email)) || '[]');
      saveCurrentUserToLS(user);
      toast('Welcome back, ' + user.name);
      return true;
    }

    function logout(){
      if(!State.currentUser) return;
      saveUserData(); // persist before leaving
      State.currentUser = null;
      State.cart = [];
      State.orders = [];
      clearCurrentUserFromLS();
      showAuth();
      toast('Logged out');
    }

    function saveUserData(){
      if(!State.currentUser) return;
      localStorage.setItem(userCartKey(State.currentUser.email), JSON.stringify(State.cart));
      localStorage.setItem(userOrdersKey(State.currentUser.email), JSON.stringify(State.orders));
    }

    /****************
     * Rendering UI
     ****************/
    function mountEventListeners(){
      // auth toggles
      $('#gotoRegister').addEventListener('click', ()=> {
        $('#loginBox').style.display='none';
        $('#registerBox').style.display='block';
      });
      $('#gotoLogin').addEventListener('click', ()=> {
        $('#registerBox').style.display='none';
        $('#loginBox').style.display='block';
      });

      // auth submit
      $('#registerForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const name = $('#regName').value.trim();
        const email = $('#regEmail').value.trim().toLowerCase();
        const pass = $('#regPassword').value;
        registerUser(name,email,pass).then(ok=>{
          if(ok) showApp();
        });
      });

      $('#loginForm').addEventListener('submit', (e)=>{
        e.preventDefault();
        const email = $('#loginEmail').value.trim().toLowerCase();
        const pass = $('#loginPassword').value;
        if(loginUser(email,pass)) showApp();
      });

      $('#logoutBtn').addEventListener('click', ()=> logout());

      // nav buttons
      $$('#navButtons button').forEach(btn=>{
        btn.addEventListener('click', ()=> {
          $$('#navButtons button').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const view = btn.getAttribute('data-view');
          showView(view);
        });
      });

      // search & sort
      $('#searchInput').addEventListener('input', (e)=> {
        State.search = e.target.value.trim().toLowerCase();
        renderProducts();
      });
      $('#sortSelect').addEventListener('change', (e)=>{
        State.sortBy = e.target.value;
        renderProducts();
      });

      // checkout flow
      $('#checkoutBtn').addEventListener('click', ()=> showView('checkout'));
      $('#cancelCheckout').addEventListener('click', ()=> showView('cart'));
      $('#checkoutForm').addEventListener('submit', e=>{
        e.preventDefault();
        placeOrder();
      });
    }

    function showAuth(){
      $('#authScreen').style.display = 'flex';
      $('#app').style.display = 'none';
    }
    function showApp(){
      $('#authScreen').style.display = 'none';
      $('#app').style.display = 'flex';
      // set user display
      $('#userName').textContent = State.currentUser ? State.currentUser.name : '‚Äî';
      renderAll();
    }

    function showView(view){
      $('#view-products').style.display='none';
      $('#view-cart').style.display='none';
      $('#view-checkout').style.display='none';
      $('#view-orders').style.display='none';
      if(view === 'products') $('#view-products').style.display='block';
      if(view === 'cart') { $('#view-cart').style.display='block'; renderCart(); }
      if(view === 'checkout'){ $('#view-checkout').style.display='block'; renderCheckout(); }
      if(view === 'orders'){ $('#view-orders').style.display='block'; renderOrders(); }
    }

    function renderAll(){
      renderCategories();
      renderProducts();
      updateCartCount();
      renderCart();
      renderOrders();
    }

    function uniqueCategories(){
      const cats = new Set(State.products.map(p=>p.category));
      return ['all', ...cats];
    }

    function renderCategories(){
      const container = $('#categoryFilters');
      const cats = uniqueCategories();
      container.innerHTML = '';
      cats.forEach(cat=>{
        const btn = document.createElement('button');
        btn.className = 'chip ' + (State.selectedCategory === cat ? 'active':'');
        btn.textContent = cat === 'all' ? 'All' : cat;
        btn.addEventListener('click', ()=>{
          State.selectedCategory = cat;
          renderCategories();
          renderProducts();
        });
        container.appendChild(btn);
      });
    }

    function renderProducts(){
      const grid = $('#productsGrid');
      let list = State.products.slice();

      // filter
      list = list.filter(p=>{
        const nameMatch = p.name.toLowerCase().includes(State.search);
        const categoryMatch = State.selectedCategory === 'all' || p.category === State.selectedCategory;
        return nameMatch && categoryMatch;
      });

      // sort
      if(State.sortBy === 'price-asc') list.sort((a,b)=>a.price-b.price);
      else if(State.sortBy === 'price-desc') list.sort((a,b)=>b.price-a.price);
      else if(State.sortBy === 'rating') list.sort((a,b)=>b.rating - a.rating);
      else if(State.sortBy === 'featured') list.sort((a,b)=> (b.featured?1:0) - (a.featured?1:0));

      grid.innerHTML = '';
      list.forEach(p=>{
        const el = document.createElement('article');
        el.className = 'product';
        el.innerHTML = `
          <div>
            <div class="media">${p.emoji || 'üì¶'}</div>
            <h3>${p.name}</h3>
            <div style="display:flex;justify-content:space-between;align-items:center" class="meta">
              <div>
                <div class="price">${fmt(p.price)}</div>
                <div class="stock">${p.stock} in stock ¬∑ ${p.category}</div>
              </div>
              <div style="text-align:right">
                <div style="font-size:13px;color:#64748b">Rating</div>
                <div style="font-weight:800">${p.rating ?? '‚Äî'}</div>
              </div>
            </div>
          </div>
          <div class="actions">
            <button class="btn btn-ghost" data-id="${p.id}">Details</button>
            <button class="btn btn-primary" data-add="${p.id}" ${p.stock===0?'disabled':''}>${p.stock===0?'Out':'Add to Cart'}</button>
          </div>
        `;
        grid.appendChild(el);
      });

      // attach add handlers
      $$('[data-add]').forEach(b=>{
        b.addEventListener('click', ()=> {
          const id = Number(b.getAttribute('data-add'));
          addToCart(id);
        });
      });

      // details buttons (simple alert for demo)
      $$('[data-id]').forEach(b=>{
        b.addEventListener('click', ()=> {
          const id = Number(b.getAttribute('data-id'));
          const p = State.products.find(x=>x.id===id);
          if(!p) return;
          alert(`${p.name}\n\nCategory: ${p.category}\nPrice: ${fmt(p.price)}\nStock: ${p.stock}\n\n${p.description ?? ''}`);
        });
      });
    }

    /*****************
     * Cart handling
     *****************/
    function cartTotalCount(){
      return State.cart.reduce((s,i)=>s + (i.quantity||0), 0);
    }
    function updateCartCount(){
      $('#navCartCount').textContent = cartTotalCount();
    }

    function addToCart(productId){
      const product = State.products.find(p=>p.id===productId);
      if(!product) return toast('Product not found',false);
      const existing = State.cart.find(i=>i.id===productId);
      if(existing){
        if(existing.quantity < product.stock){ existing.quantity++; toast('Quantity updated') }
        else { toast('Max stock reached', false); return; }
      } else {
        State.cart.push({ id:product.id, name:product.name, price:product.price, emoji:product.emoji, quantity:1 });
        toast('Added to cart');
      }
      saveUserData();
      updateCartCount();
      renderCart();
    }

    function updateCartQuantity(productId, delta){
      const item = State.cart.find(i=>i.id===productId);
      if(!item) return;
      const product = State.products.find(p=>p.id===productId);
      if(!product) return;

      const newQty = (item.quantity||0) + delta;
      if(newQty <= 0){
        // remove
        State.cart = State.cart.filter(i=>i.id!==productId);
        toast('Removed from cart');
      } else if(newQty > product.stock){
        toast('Maximum stock reached', false);
        return;
      } else {
        item.quantity = newQty;
      }
      saveUserData();
      renderCart();
      updateCartCount();
    }

    function removeCartItem(productId){
      State.cart = State.cart.filter(i=>i.id!==productId);
      saveUserData();
      renderCart();
      updateCartCount();
      toast('Removed');
    }

    function calculateCartSubtotal(){
      return State.cart.reduce((s,i)=>s + i.price * i.quantity, 0);
    }

    function renderCart(){
      const list = $('#cartList');
      list.innerHTML = '';
      if(State.cart.length === 0){
        list.innerHTML = `<div style="text-align:center;padding:36px;color:#64748b">Your cart is empty ‚Äî add some items.</div>`;
        $('#summarySubtotal').textContent = fmt(0);
        $('#summaryTotal').textContent = fmt(0);
        return;
      }

      State.cart.forEach(item=>{
        const row = document.createElement('div');
        row.className = 'cart-item';
        row.innerHTML = `
          <div class="emoji">${item.emoji || 'üì¶'}</div>
          <div class="info">
            <div style="font-weight:700">${item.name}</div>
            <div class="muted">${fmt(item.price)} each</div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
            <div class="qty">
              <button class="dec">‚àí</button>
              <div style="min-width:28px;text-align:center">${item.quantity}</div>
              <button class="inc">+</button>
            </div>
            <div style="text-align:right">
              <div style="font-weight:800;color:#4338ca">${fmt(item.price * item.quantity)}</div>
              <button class="btn btn-ghost remove" style="margin-top:6px">Remove</button>
            </div>
          </div>
        `;
        list.appendChild(row);

        row.querySelector('.inc').addEventListener('click', ()=> updateCartQuantity(item.id, 1));
        row.querySelector('.dec').addEventListener('click', ()=> updateCartQuantity(item.id, -1));
        row.querySelector('.remove').addEventListener('click', ()=> removeCartItem(item.id));
      });

      const subtotal = calculateCartSubtotal();
      $('#summarySubtotal').textContent = fmt(subtotal);
      $('#summaryTotal').textContent = fmt(subtotal);
      updateCartCount();
    }

    /****************
     * Checkout / Orders
     ****************/
    function renderCheckout(){
      const subtotal = calculateCartSubtotal();
      $('#checkoutAmount').textContent = fmt(subtotal);
      // prefill card name
      if(State.currentUser) $('#cardName').value = State.currentUser.name;
    }

    function placeOrder(){
      if(State.cart.length === 0){ toast('Cart is empty', false); return; }
      // simple validation
      const card = $('#cardNumber').value.trim();
      const name = $('#cardName').value.trim();
      const expiry = $('#cardExpiry').value.trim();
      const cvv = $('#cardCvv').value.trim();
      const ship = $('#shipAddress').value.trim();
      if(!card || !name || !expiry || !cvv || !ship){ toast('Please complete payment & address', false); return; }

      const order = {
        id: 'ORD' + Date.now(),
        date: new Date().toISOString(),
        items: JSON.parse(JSON.stringify(State.cart)),
        total: calculateCartSubtotal(),
        shippingAddress: ship,
        status: 'Processing'
      };

      State.orders.unshift(order);
      State.cart = [];
      saveUserData();
      toast('Order placed ‚Äî thanks!');
      showView('orders');
      renderOrders();
      updateCartCount();
    }

    function renderOrders(){
      const target = $('#ordersList');
      target.innerHTML = '';
      if(!State.orders || State.orders.length === 0){
        target.innerHTML = `<div style="text-align:center;padding:36px;color:#64748b">No orders yet ‚Äî place your first order</div>`;
        return;
      }
      State.orders.forEach(order=>{
        const el = document.createElement('div');
        el.className = 'order';
        el.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Order ${order.id}</div>
              <div class="muted">${new Date(order.date).toLocaleString()}</div>
            </div>
            <div style="font-weight:800;color:#4338ca">${fmt(order.total)}</div>
          </div>
          <div style="margin-top:12px">
            ${order.items.map(it=>`<div style="display:flex;justify-content:space-between;padding:6px 0"><div>${it.emoji||'üì¶'} ${it.name} x${it.quantity}</div><div>${fmt(it.price*it.quantity)}</div></div>`).join('')}
          </div>
          <div style="margin-top:10px;display:flex;justify-content:space-between;align-items:center">
            <div class="muted">Ship to: ${order.shippingAddress || '‚Äî'}</div>
            <div style="background:#eef2ff;color:#3730a3;padding:6px 12px;border-radius:999px;font-weight:700">${order.status}</div>
          </div>
        `;
        target.appendChild(el);
      });
    }

    /******************
     * Boot sequence
     ******************/
    function startApp(){
      ensureSeeded();
      loadProducts();
      mountEventListeners();

      // attempt restore session
      if(loadSession()){
        showApp();
      } else {
        showAuth();
      }

      // render products even if not logged in (allow browse)
      renderProducts();
    }

    // gracefully save when leaving
    window.addEventListener('beforeunload', ()=> saveUserData());

    // start
    startApp();
  </script>
</body>
</html>
